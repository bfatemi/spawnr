#cloud-config
bootcmd:
  - echo 'GITHUB_PAT=895032ca1c6d747e5c8800cdf98e35f129b667eb' >> /etc/environment
  - echo 'R_PROFILE=/usr/lib/R/etc/.Rprofile' >> /etc/environment
users:
  - name: ruser
    groups: sudo
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash
    ssh-authorized-keys:
      - github.com,192.30.253.113 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==
      - 192.30.253.112 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==
package_upgrade: true
packages:
  - apache2
  - build-essential
  - libxml2-dev
  - libcurl4-openssl-dev
write_files:
  - path: /install_rstudio_ocpu.sh
    content: |
      #!/bin/bash
      sudo debconf-set-selections <<< "postfix postfix/mailname string hpds.io"
      sudo debconf-set-selections <<< "postfix postfix/main_mailer_type string 'Internet Site'"
      sudo apt-get install -y postfix
      sudo apt-get install -y opencpu
      sudo apt-get install -y rstudio-server
      sudo rstudio-server restart
  - path: /init_server.R
    content: |
      tryCatch({
        pkgs <- c('data.table')
        rep <- 'http://cran.rstudio.com/'
        do.call(install.packages, list(pkgs, .Library, repos=rep))
      }, error = function(c){
        stop("\n\nError installing default packages... ", c$message)
      })
      tryCatch({
        pkgs.gh <- c('bfatemi/ninjar', 'bfatemi/easydata', 'bfatemi/spawnr')
        lapply(pkgs.gh, devtools::install_github)
      }, error = function(c){
        stop("\n\nError installing github packages... ", c$message)
      })
      library(data.table)
      library(devtools)
      library(httr)
      library(stringr)
      library(spawnr)
      bres <- TRUE
      pkgs <- c("data.table", "stringr")
      tryCatch({
        bres <<- set_default_pkgs(pkgs)
      }, error = function(c){
        stop("set_default_pkgs failed (did not return boolean as expected)...Here is the error: ", c$message)
      })
      if(bres == FALSE)
        stop("set_default_pkgs ran with no errors but returned FALSE. Stopping execution")
      tryCatch({
        bres <<- connect_github()
      }, error = function(c){
        stop("connect_github failed (did not return boolean as expected)... Here is the error: ", c$message)
      })
      if(bres == FALSE)
        stop("connect_github ran with no errors but returned FALSE. Stopping execution")
runcmd:
  - 'echo "deb http://cran.rstudio.com/bin/linux/ubuntu xenial/" | sudo tee -a /etc/apt/sources.list'
  - gpg --keyserver keyserver.ubuntu.com --recv-key E084DAB9
  - gpg -a --export E084DAB9 | sudo apt-key add -
  - sudo add-apt-repository -y ppa:opencpu/opencpu-1.6
  - sudo apt-get update -y
  - sudo apt-get install -y r-base r-base-dev libssl-dev libcurl4-gnutls-dev libssh2-1-dev
  - sudo chmod +x /install_rstudio_ocpu.sh
  - sudo /install_rstudio_ocpu.sh
  - Rscript --vanilla /init_server.R > R_init_server_log
power_state:
 mode: reboot
 message: Bye Bye
 timeout: 30
 condition: True
